"use strict";(()=>{var e={};e.id=26,e.ids=[26],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},1660:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>y,requestAsyncStorage:()=>c,routeModule:()=>f,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p});var a={};r.r(a),r.d(a,{GET:()=>d,POST:()=>m});var s=r(9303),i=r(8716),n=r(670),o=r(7070),u=r(9178),l=r(9487);async function d(e){let t=await (0,u.Sp)(e);if(!t)return o.NextResponse.json({error:"Ungueltiger Bot-Key"},{status:401});if(!t.scopes.includes("alarms:read"))return o.NextResponse.json({error:"Scope alarms:read erforderlich"},{status:403});let r=await l.DB.getAlarms(t.userId);return o.NextResponse.json({alarms:r})}async function m(e){let t=await (0,u.Sp)(e);if(!t)return o.NextResponse.json({error:"Ungueltiger Bot-Key"},{status:401});if(!t.scopes.includes("alarms:write"))return o.NextResponse.json({error:"Scope alarms:write erforderlich"},{status:403});if(await l.DB.countAlarms(t.userId)>=50)return o.NextResponse.json({error:"Alarm-Limit erreicht"},{status:429});let r=await e.json(),a=await l.DB.createAlarm({id:(0,l.Ox)(),user_id:t.userId,name:r.name||"Bot-Alarm",active:r.active??!0,time:r.time||"07:00",days:r.days||[],snooze_enabled:r.snoozeEnabled??!0,snooze_duration:r.snoozeDuration||5,sound:r.sound||"default",vibration:r.vibration??!0,briefing_mode:r.briefingMode||"auto",managed_by:"bot",created_at:new Date().toISOString(),updated_at:new Date().toISOString()});return await l.DB.addAudit({id:(0,l.Ox)(),user_id:t.userId,actor:"bot",action:`Alarm "${a.name}" erstellt`,target:a.id,details:`${a.time}`,created_at:new Date().toISOString()}),o.NextResponse.json({alarm:a},{status:201})}let f=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/bot/alarms/route",pathname:"/api/bot/alarms",filename:"route",bundlePath:"app/api/bot/alarms/route"},resolvedPagePath:"/data/.openclaw/workspace/AlarmBriefing/app/api/bot/alarms/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:g}=f,_="/api/bot/alarms/route";function y(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}},9178:(e,t,r)=>{r.d(t,{AY:()=>u,Sp:()=>l,fT:()=>o});var a=r(1482),s=r.n(a),i=r(9487);let n=process.env.JWT_SECRET||"ab-dev-secret-change-in-prod";function o(e){return s().sign({userId:e},n,{expiresIn:"30d"})}function u(e){let t=e.headers.get("authorization");if(!t?.startsWith("Bearer "))return null;let r=function(e){try{return s().verify(e,n)}catch{return null}}(t.slice(7));return r?.userId||null}async function l(e){let t=e.headers.get("x-bot-key");if(!t)return null;let r=(0,i.Ym)(t),a=await i.DB.getBotByHash(r);return a?{userId:a.user_id,scopes:a.scopes}:null}},9487:(e,t,r)=>{r.d(t,{DB:()=>m,Ox:()=>o,Ym:()=>n,f1:()=>u});var a=r(4770),s=r.n(a),i=r(569);function n(e){return s().createHash("sha256").update(e).digest("hex")}function o(){return s().randomUUID()}function u(){return`ab_${s().randomBytes(32).toString("hex")}`}let l=globalThis;l.__mem||(l.__mem={users:new Map,alarms:new Map,botKeys:new Map,auditLog:[],briefings:new Map});let d=l.__mem,m={async createUser(e){if((0,i.jv)()){let{data:t,error:r}=await (0,i.tG)().from("app_users").insert(e).select().single();if(r)throw Error(r.message);return t}return d.users.set(e.id,e),e},async getUserByEmail(e){if((0,i.jv)()){let{data:t}=await (0,i.tG)().from("app_users").select("*").eq("email",e).single();return t}for(let[,t]of d.users)if(t.email===e)return t;return null},async getUserById(e){if((0,i.jv)()){let{data:t}=await (0,i.tG)().from("app_users").select("*").eq("id",e).single();return t}return d.users.get(e)||null},async deleteUser(e){if((0,i.jv)()){await (0,i.tG)().from("briefings").delete().eq("user_id",e),await (0,i.tG)().from("audit_log").delete().eq("user_id",e),await (0,i.tG)().from("app_bot_keys").delete().eq("user_id",e),await (0,i.tG)().from("alarms").delete().eq("user_id",e),await (0,i.tG)().from("app_users").delete().eq("id",e);return}for(let[t,r]of(d.users.delete(e),d.alarms.delete(e),d.briefings.delete(e),d.botKeys))r.user_id===e&&d.botKeys.delete(t);l.__mem.auditLog=d.auditLog.filter(t=>t.user_id!==e)},async getAlarms(e){if((0,i.jv)()){let{data:t}=await (0,i.tG)().from("alarms").select("*").eq("user_id",e).order("time");return t||[]}return d.alarms.get(e)||[]},async createAlarm(e){if((0,i.jv)()){let{data:t,error:r}=await (0,i.tG)().from("alarms").insert(e).select().single();if(r)throw Error(r.message);return t}let t=d.alarms.get(e.user_id)||[];return t.push(e),d.alarms.set(e.user_id,t),e},async updateAlarm(e,t,r){if((0,i.jv)()){let{data:a,error:s}=await (0,i.tG)().from("alarms").update({...r,updated_at:new Date().toISOString()}).eq("id",e).eq("user_id",t).select().single();return s?null:a}let a=d.alarms.get(t)||[],s=a.findIndex(t=>t.id===e);return -1===s?null:(a[s]={...a[s],...r,updated_at:new Date().toISOString()},a[s])},async deleteAlarm(e,t){if((0,i.jv)()){let{error:r}=await (0,i.tG)().from("alarms").delete().eq("id",e).eq("user_id",t);return!r}let r=d.alarms.get(t)||[];return d.alarms.set(t,r.filter(t=>t.id!==e)),!0},async countAlarms(e){if((0,i.jv)()){let{count:t}=await (0,i.tG)().from("alarms").select("*",{count:"exact",head:!0}).eq("user_id",e);return t||0}return(d.alarms.get(e)||[]).length},async createBotKey(e){if((0,i.jv)()){await (0,i.tG)().from("app_bot_keys").delete().eq("user_id",e.user_id),await (0,i.tG)().from("app_bot_keys").insert(e);return}for(let[t,r]of d.botKeys)r.user_id===e.user_id&&d.botKeys.delete(t);d.botKeys.set(e.hash,e)},async getBotByHash(e){if((0,i.jv)()){let{data:t}=await (0,i.tG)().from("app_bot_keys").select("*").eq("hash",e).single();return t}return d.botKeys.get(e)||null},async deleteBotKeys(e){if((0,i.jv)()){await (0,i.tG)().from("app_bot_keys").delete().eq("user_id",e);return}for(let[t,r]of d.botKeys)r.user_id===e&&d.botKeys.delete(t)},async addAudit(e){if((0,i.jv)()){await (0,i.tG)().from("audit_log").insert(e);return}d.auditLog.push(e)},async getAudit(e,t=50){if((0,i.jv)()){let{data:r}=await (0,i.tG)().from("audit_log").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(t);return r||[]}return d.auditLog.filter(t=>t.user_id===e).slice(-t)},async createBriefing(e){if((0,i.jv)()){let{data:t,error:r}=await (0,i.tG)().from("briefings").insert(e).select().single();if(r)throw Error(r.message);return t}let t=d.briefings.get(e.user_id)||[];return t.push(e),t.length>100&&t.shift(),d.briefings.set(e.user_id,t),e},async getLatestBriefing(e,t){if((0,i.jv)()){let{data:r}=await (0,i.tG)().from("briefings").select("*").eq("user_id",e).eq("alarm_id",t).order("created_at",{ascending:!1}).limit(1).single();return r}let r=(d.briefings.get(e)||[]).filter(e=>e.alarm_id===t);return r[r.length-1]||null}}},569:(e,t,r)=>{r.d(t,{jv:()=>n,tG:()=>u});var a=r(7857);let s=process.env.NEXT_PUBLIC_SUPABASE_URL||"";process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;let i=process.env.SUPABASE_SERVICE_ROLE_KEY||"",n=()=>!!s&&!!i,o=null,u=()=>n()?(o||(o=(0,a.eI)(s,i)),o):null}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,564,482],()=>r(1660));module.exports=a})();