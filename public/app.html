<!DOCTYPE html>
<html lang="de" id="html-root">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AlarmBriefing</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîî</text></svg>">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap');
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#0a0e1a;--bg-card:#111827;--bg-card-hover:#1a2235;--bg-input:#0d1220;--border:#1e2a42;--blue:#3b82f6;--blue-light:#60a5fa;--blue-dark:#1d4ed8;--blue-glow:rgba(59,130,246,0.4);--blue-muted:rgba(59,130,246,0.12);--text:#e2e8f0;--text-dim:#64748b;--text-muted:#475569;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444}
    html,body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);height:100%;overflow:hidden}
    body{display:flex;align-items:center;justify-content:center}
    body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at 30% 20%,rgba(59,130,246,0.06) 0%,transparent 60%),radial-gradient(ellipse at 70% 80%,rgba(59,130,246,0.04) 0%,transparent 50%);pointer-events:none;z-index:0}
    .phone{width:390px;height:100%;max-height:844px;position:relative;z-index:1;display:flex;flex-direction:column;overflow:hidden}
    @media(min-width:500px){.phone{height:90vh;border-radius:40px;border:2px solid var(--border);box-shadow:0 20px 80px rgba(0,0,0,0.5)}}
    @media(max-width:500px){.phone{width:100%;max-height:100%}}

    .screen{display:none;flex-direction:column;flex:1;overflow:hidden}
    .screen.active{display:flex}

    /* Auth Screen */
    .auth{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:24px;text-align:center}
    .auth-icon{font-size:48px;margin-bottom:12px}
    .auth-title{font-size:22px;font-weight:700;margin-bottom:4px}
    .auth-title span{color:var(--blue)}
    .auth-desc{font-size:13px;color:var(--text-dim);margin-bottom:20px;max-width:280px;line-height:1.5}
    .auth-form{width:100%;max-width:300px;display:flex;flex-direction:column;gap:10px}
    .auth-error{font-size:12px;color:var(--danger);min-height:16px;text-align:center}
    .auth-switch{font-size:13px;color:var(--text-dim);margin-top:12px;cursor:pointer}
    .auth-switch span{color:var(--blue);font-weight:600}

    /* Onboarding */
    .ob{flex:1;display:flex;flex-direction:column;padding:24px;justify-content:space-between}
    .ob-progress{display:flex;justify-content:center;gap:8px;margin-bottom:16px}
    .ob-dot{width:8px;height:8px;border-radius:4px;background:var(--border);transition:all .3s}
    .ob-dot.active{background:var(--blue);width:24px;box-shadow:0 0 10px var(--blue-glow)}
    .ob-body{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
    .ob-icon{font-size:48px;margin-bottom:12px}
    .ob-title{font-size:22px;font-weight:700;margin-bottom:6px;line-height:1.3}
    .ob-title span{color:var(--blue)}
    .ob-desc{font-size:13px;color:var(--text-dim);line-height:1.5;max-width:300px;margin-bottom:14px}
    .ob-box{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;text-align:left;width:100%;max-width:320px;margin-bottom:10px}
    .ob-box-title{font-size:11px;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
    .ob-box p{font-size:12px;color:var(--text-dim);line-height:1.5;margin-bottom:2px}
    .ob-key{background:var(--bg-input);border:1px solid var(--border);border-radius:10px;padding:10px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--blue-light);word-break:break-all;width:100%;max-width:320px;text-align:center;cursor:pointer;user-select:all;margin-bottom:6px}
    .ob-key-hint{font-size:11px;color:var(--text-muted)}
    .ob-footer{display:flex;gap:10px;padding-top:10px}

    /* Buttons */
    .btn{padding:12px 24px;border:1px solid var(--border);background:var(--bg-card);color:var(--text);border-radius:14px;cursor:pointer;font-size:14px;font-family:'Inter',sans-serif;font-weight:600;transition:all .2s}
    .btn:hover{border-color:rgba(59,130,246,0.3)}.btn:active{transform:scale(0.97)}
    .btn-blue{background:linear-gradient(135deg,var(--blue),var(--blue-dark));border-color:var(--blue);color:white;box-shadow:0 0 20px var(--blue-glow)}
    .btn-sm{padding:8px 16px;font-size:12px;border-radius:10px}
    .btn-full{width:100%}.btn-flex{flex:1}
    .btn:disabled{opacity:0.5;cursor:not-allowed}

    .input{width:100%;padding:11px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;font-family:'Inter',sans-serif;outline:none;transition:border-color .3s}
    .input:focus{border-color:var(--blue)}

    /* Home */
    .home-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px 6px;flex-shrink:0}
    .home-title{font-size:20px;font-weight:800}.home-title span{color:var(--blue)}
    .home-sub{font-size:11px;color:var(--text-dim);margin-top:1px}
    .home-user{font-size:10px;color:var(--text-muted)}
    .icon-btn{width:38px;height:38px;border-radius:10px;background:var(--bg-card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;transition:all .2s}
    .icon-btn:hover{border-color:rgba(59,130,246,0.3)}

    .next-alarm{margin:8px 20px;padding:12px 14px;background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(59,130,246,0.05));border:1px solid rgba(59,130,246,0.2);border-radius:14px;display:flex;align-items:center;gap:10px;flex-shrink:0}
    .na-icon{font-size:24px}.na-time{font-family:'JetBrains Mono',monospace;font-size:26px;font-weight:700;color:var(--blue-light)}
    .na-label{font-size:11px;color:var(--text-dim)}.na-brief{font-size:10px;color:var(--blue);margin-top:1px}

    .briefing-player{margin:6px 20px;padding:10px 14px;background:var(--bg-card);border:1px solid rgba(59,130,246,0.2);border-radius:12px;display:none;flex-shrink:0;align-items:center;gap:10px}
    .briefing-player.active{display:flex}
    .bp-play{width:34px;height:34px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px;color:white;flex-shrink:0}
    .bp-info{flex:1}.bp-title{font-size:12px;font-weight:600}.bp-sub{font-size:10px;color:var(--text-dim)}
    .bp-wave{display:flex;align-items:center;gap:2px;height:18px}
    .bp-bar{width:3px;border-radius:2px;background:var(--blue);animation:wave 1s ease-in-out infinite}
    .bp-bar:nth-child(1){height:7px;animation-delay:0s}.bp-bar:nth-child(2){height:14px;animation-delay:.15s}.bp-bar:nth-child(3){height:9px;animation-delay:.3s}.bp-bar:nth-child(4){height:18px;animation-delay:.45s}.bp-bar:nth-child(5){height:11px;animation-delay:.6s}
    @keyframes wave{0%,100%{transform:scaleY(1)}50%{transform:scaleY(0.4)}}

    .alarm-list{flex:1;overflow-y:auto;padding:6px 20px 60px}
    .alarm-card{display:flex;align-items:center;justify-content:space-between;background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:12px 14px;margin-bottom:8px;cursor:pointer;transition:all .2s}
    .alarm-card:hover{border-color:rgba(59,130,246,0.25);background:var(--bg-card-hover)}
    .alarm-card.inactive{opacity:0.4}
    .alarm-time{font-family:'JetBrains Mono',monospace;font-size:26px;font-weight:700;line-height:1}
    .alarm-meta{font-size:11px;color:var(--text-dim);margin-top:2px}
    .alarm-days{display:flex;gap:3px;margin-top:3px}
    .day-tag{font-size:8px;font-weight:600;color:var(--blue-light);background:var(--blue-muted);padding:2px 5px;border-radius:4px}
    .bot-tag{font-size:8px;font-weight:700;letter-spacing:1px;color:var(--blue);background:var(--blue-muted);border:1px solid rgba(59,130,246,0.2);padding:1px 6px;border-radius:4px}
    .toggle{width:42px;height:22px;border-radius:11px;background:var(--border);cursor:pointer;position:relative;transition:background .3s;flex-shrink:0}
    .toggle.on{background:var(--blue-muted)}
    .toggle::after{content:'';position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:var(--text-dim);transition:all .3s}
    .toggle.on::after{left:23px;background:var(--blue);box-shadow:0 0 8px var(--blue-glow)}
    .fab{position:absolute;bottom:16px;right:16px;width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--blue-dark));display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 0 20px var(--blue-glow);font-size:24px;color:white;z-index:10;transition:all .2s}
    .fab:hover{transform:scale(1.1)}
    .empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;color:var(--text-dim);padding:20px}
    .empty-state .icon{font-size:40px;margin-bottom:10px;opacity:0.5}

    /* Settings */
    .settings-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);flex-shrink:0}
    .back-link{color:var(--blue);cursor:pointer;font-size:13px;font-weight:500}
    .settings-body{flex:1;overflow-y:auto;padding:0 20px 20px}
    .s-title{font-size:10px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.5px;margin:14px 0 6px}
    .s-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .s-row{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;border-bottom:1px solid var(--border);font-size:13px}
    .s-row:last-child{border-bottom:none}
    .s-dim{color:var(--text-dim);font-size:12px}
    .s-explain{padding:10px 14px;border-bottom:1px solid var(--border);font-size:11px;color:var(--text-dim);line-height:1.5;background:rgba(59,130,246,0.03)}
    .api-key-box{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--blue-light);background:var(--bg-input);padding:10px 14px;word-break:break-all;user-select:all;cursor:pointer;border-bottom:1px solid var(--border)}
    .conn-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
    .conn-dot.on{background:var(--success);box-shadow:0 0 6px rgba(34,197,94,0.5)}
    .conn-dot.off{background:var(--danger)}
    .s-row.danger{color:var(--danger)}

    /* Modal */
    .modal-bg{display:none;position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);z-index:50;align-items:flex-end}
    .modal-bg.active{display:flex}
    .modal{width:100%;max-height:80%;background:var(--bg);border-top-left-radius:20px;border-top-right-radius:20px;border:1px solid var(--border);border-bottom:none;overflow-y:auto;animation:slideUp .3s ease-out}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal-bar{width:32px;height:4px;background:var(--border);border-radius:2px;margin:8px auto}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:4px 20px 12px}
    .modal-title{font-size:16px;font-weight:700}
    .modal-close{color:var(--blue);cursor:pointer;font-size:13px;font-weight:600}
    .modal-body{padding:0 20px 20px}
    .time-input{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:16px}
    .time-field{font-family:'JetBrains Mono',monospace;font-size:44px;font-weight:700;width:82px;text-align:center;background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:6px;color:var(--text);outline:none}
    .time-field:focus{border-color:var(--blue)}
    .time-colon{font-family:'JetBrains Mono',monospace;font-size:36px;color:var(--blue)}
    .field{margin-bottom:12px}.field-label{font-size:10px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px}
    .days-row{display:flex;gap:4px}
    .day-btn{flex:1;text-align:center;padding:8px 0;border-radius:8px;background:var(--bg-card);border:1px solid var(--border);color:var(--text-dim);font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;font-family:'Inter',sans-serif}
    .day-btn.active{background:var(--blue-muted);border-color:var(--blue);color:var(--blue)}
    .radio-group{display:flex;flex-direction:column;gap:5px}
    .radio-opt{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all .2s;font-size:12px}
    .radio-opt.active{border-color:var(--blue);background:var(--blue-muted)}
    .rdot{width:16px;height:16px;border-radius:50%;border:2px solid var(--text-dim);display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .radio-opt.active .rdot{border-color:var(--blue)}
    .rdot-in{width:7px;height:7px;border-radius:50%;background:var(--blue);display:none}
    .radio-opt.active .rdot-in{display:block}

    .loading{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;font-size:12px;color:var(--text-dim)}
    .spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div class="phone" id="app">

  <!-- AUTH -->
  <div class="screen active" id="s-auth">
    <div class="auth">
      <div class="auth-icon">üîî</div>
      <div class="auth-title">Alarm<span>Briefing</span></div>
      <div class="auth-desc" id="auth-desc"></div>
      <div class="auth-form" id="auth-form">
        <input class="input" id="auth-name">
        <input class="input" id="auth-email" type="email" autocomplete="email">
        <input class="input" id="auth-pass" type="password" autocomplete="current-password">
        <div class="auth-error" id="auth-error"></div>
        <button class="btn btn-blue btn-full" id="auth-btn" onclick="doAuth()"></button>
      </div>
      <div class="auth-switch" id="auth-switch" onclick="toggleAuthMode()">
        Schon registriert? <span>Anmelden</span>
      </div>
    </div>
  </div>

  <!-- ONBOARDING -->
  <div class="screen" id="s-onboarding">
    <div class="ob">
      <div class="ob-progress"><div class="ob-dot active" data-s="0"></div><div class="ob-dot" data-s="1"></div><div class="ob-dot" data-s="2"></div></div>
      <div class="ob-body" id="ob-body"></div>
      <div class="ob-footer" id="ob-footer"></div>
    </div>
  </div>

  <!-- HOME -->
  <div class="screen" id="s-home">
    <div class="home-header">
      <div>
        <div class="home-title">Alarm<span>Briefing</span></div>
        <div class="home-sub" id="home-sub"></div>
      </div>
      <div style="display:flex;gap:6px">
        <div class="icon-btn" onclick="showScreen('settings')">‚öô</div>
        <div class="icon-btn" onclick="logout()">üö™</div>
      </div>
    </div>
    <div class="next-alarm" id="next-alarm" style="display:none">
      <div class="na-icon">‚è∞</div>
      <div><div class="na-time" id="na-time"></div><div class="na-label" id="na-label"></div><div class="na-brief" id="na-brief"></div></div>
    </div>
    <div class="briefing-player" id="bp"><div class="bp-play" onclick="togglePlay()">‚ñ∂</div><div class="bp-info"><div class="bp-title" id="bp-title"></div><div class="bp-sub" id="bp-sub"></div></div><div class="bp-wave" id="bp-wave" style="display:none"><div class="bp-bar"></div><div class="bp-bar"></div><div class="bp-bar"></div><div class="bp-bar"></div><div class="bp-bar"></div></div></div>
    <div class="alarm-list" id="alarm-list"></div>
    <div class="fab" onclick="openModal()">+</div>
  </div>

  <!-- SETTINGS -->
  <div class="screen" id="s-settings">
    <div class="settings-header">
      <span class="back-link" onclick="showScreen('home')" id="settings-back"></span>
      <span style="font-weight:600;font-size:15px" id="settings-title"></span>
      <span style="width:50px"></span>
    </div>
    <div class="settings-body" id="settings-body"></div>
  </div>

  <!-- ALARM OVERLAY (when alarm triggers) -->
  <div class="modal-bg" id="alarm-overlay" style="align-items:center;justify-content:center">
    <div style="text-align:center;padding:30px">
      <div style="font-size:64px;margin-bottom:16px;animation:float 2s ease-in-out infinite">‚è∞</div>
      <div id="alarm-overlay-time" style="font-family:'JetBrains Mono',monospace;font-size:48px;font-weight:700;color:var(--blue-light)">07:00</div>
      <div id="alarm-overlay-name" style="font-size:16px;color:var(--text-dim);margin:8px 0 24px">Morgenwecker</div>
      <div style="display:flex;gap:12px;justify-content:center">
        <button class="btn" onclick="snoozeAlarm()" style="min-width:120px" id="alarm-snooze-btn"></button>
        <button class="btn btn-blue" onclick="dismissAlarm()" style="min-width:120px" id="alarm-dismiss-btn"></button>
      </div>
      <div style="margin-top:16px;font-size:12px;color:var(--text-muted)" id="alarm-overlay-status"></div>
    </div>
  </div>
  <style>
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
  </style>

  <!-- ALARM MODAL -->
  <div class="modal-bg" id="modal" onclick="if(event.target===this)closeModal()">
    <div class="modal">
      <div class="modal-bar"></div>
      <div class="modal-head"><span class="modal-title" id="modal-title"></span><span class="modal-close" onclick="closeModal()" id="modal-done"></span></div>
      <div class="modal-body">
        <div class="time-input"><input class="time-field" id="m-h" value="07" maxlength="2"><span class="time-colon">:</span><input class="time-field" id="m-m" value="00" maxlength="2"></div>
        <div class="field"><div class="field-label" id="m-name-label"></div><input class="input" id="m-name"></div>
        <div class="field"><div class="field-label" id="m-days-label"></div><div class="days-row" id="m-days"></div></div>
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:12px">
          <div style="font-size:11px;color:var(--blue);font-weight:600;margin-bottom:3px" id="m-briefing-title"></div>
          <div style="font-size:11px;color:var(--text-dim);line-height:1.4" id="m-briefing-desc"></div>
        </div>
        <button class="btn btn-blue btn-full" onclick="saveAlarm()" id="m-save-btn"></button>
      </div>
    </div>
  </div>
</div>

<script>
const API = '';

// === i18n ===
const browserLang = (navigator.language || 'en').slice(0, 2);
const LANG = ['de'].includes(browserLang) ? browserLang : 'en';
document.getElementById('html-root').lang = LANG;

const I18N = {
  de: {
    days: ['So','Mo','Di','Mi','Do','Fr','Sa'],
    authDesc: 'Melde dich an um deine Wecker und Briefings ger√§te√ºbergreifend zu synchronisieren.',
    register: 'Registrieren', login: 'Anmelden',
    switchToLogin: 'Schon registriert? <span>Anmelden</span>',
    switchToRegister: 'Noch kein Account? <span>Registrieren</span>',
    namePlaceholder: 'Name (optional)', emailPlaceholder: 'Email', passPlaceholder: 'Passwort (min. 8 Zeichen)',
    alarmsActive: (n) => `${n} Alarm${n!==1?'e':''} aktiv`,
    briefingByBot: 'üéô Briefing wird vom Bot erstellt',
    morningBriefing: 'Morgenbriefing', briefingSources: 'Wetter, Termine, News',
    noAlarms: 'Noch keine Wecker.<br>Tippe + oder lass deinen Bot einen erstellen.',
    noBriefing: 'Noch kein Briefing vorhanden. Dein Bot wird eins erstellen.',
    newAlarm: 'Neuer Wecker', done: 'Fertig', name: 'Name', weekdays: 'Wochentage', save: 'Speichern',
    briefingTitle: 'ü§ñ Briefing', briefingDesc: 'Dein Clawdbot entscheidet automatisch was ins Briefing kommt ‚Äî Wetter, Kalender, News etc. Du musst nichts einstellen.',
    settings: 'Einstellungen', back: '‚Üê Zur√ºck',
    botConnection: 'Bot-Verbindung', newKey: 'üîë Neuen Key generieren', copy: 'üìã Kopieren',
    noBotConnected: 'Kein Bot verbunden', keyGenerated: 'Key generiert ‚Äî kopieren und dem Bot geben',
    briefingSourcesTitle: 'Briefing-Quellen', briefingSourcesDesc: 'Dein Bot sammelt diese Daten und erstellt daraus ein Audio-Briefing das beim Alarm abgespielt wird ‚Äî wie Jarvis.',
    weather: 'üå§ Wetter', calendar: 'üìÖ Kalender', news: 'üì∞ Nachrichten', tasks: '‚úÖ Aufgaben',
    audioTitle: 'Audio', audioDesc: 'Stimme und Tempo f√ºr dein Audio-Briefing √ºber die Lautsprecher.',
    voice: 'Stimme', speed: 'Tempo',
    account: 'Account', email: 'Email', exportData: 'üì¶ Daten exportieren', logout: 'üö™ Abmelden', deleteAccount: 'üóë Account l√∂schen',
    legal: 'Rechtliches', privacy: 'Datenschutzerkl√§rung', terms: 'Nutzungsbedingungen', imprint: 'Impressum', support: 'Support & Hilfe',
    botActivity: 'Bot-Aktivit√§ten', noActivity: 'Noch keine Aktivit√§ten',
    snooze: 'üò¥ Snooze', dismiss: '‚úÖ Aufstehen', briefingAfter: 'üéô Briefing wird nach dem Alarm vorgelesen...',
    deleteConfirm: 'Account wirklich l√∂schen? Alle Daten werden unwiderruflich gel√∂scht:\n\n- Account & Login\n- Alle Wecker\n- Alle API-Keys\n- Alle Briefings\n- Audit-Logs\n\nDas kann nicht r√ºckg√§ngig gemacht werden.',
    deleteConfirm2: 'Bist du sicher? Letzte Chance.',
    oneTime: 'Einmalig',
    obWelcomeTitle: 'Willkommen bei<br><span>AlarmBriefing</span>',
    obWelcomeDesc: 'Dein intelligenter Wecker mit Jarvis-Briefings. Der Clawdbot erstellt Wecker und spricht dir morgens Wetter, Termine und News √ºber deine Lautsprecher vor.',
    obHowTitle: "So funktioniert's",
    obHow1: 'ü§ñ Dein Clawdbot steuert alles automatisch', obHow2: '‚è∞ Er erstellt Wecker f√ºr dich',
    obHow3: 'üéô Er generiert Audio-Briefings (wie Jarvis)', obHow4: 'üîä Beim Alarm h√∂rst du dein Briefing',
    obConnectTitle: 'Bot verbinden', obConnectDesc: 'Generiere jetzt einen API-Key und gib ihn deinem Clawdbot. Damit kann er auf deine App zugreifen.',
    obGenBtn: 'üîë Key generieren', obGenerating: 'Generiere...',
    obKeyGenerated: '‚úÖ Key generiert!', obKeyCopyHint: 'Kopiere diesen Key und gib ihn deinem Clawdbot als <b>ALARMBRIEFING_API_KEY</b>:',
    obTapCopy: 'Antippen zum Kopieren', obConnectLater: 'Sp√§ter verbinden',
    obReadyTitle: 'Alles bereit!', obReadyDesc: 'Dein Clawdbot kann jetzt Wecker erstellen und Briefings generieren. Du wirst morgens wie Tony Stark geweckt.',
    obNext: 'Weiter ‚Üí', obBack: 'Zur√ºck', obStart: 'App starten',
    obBotKeyDone: '‚úÖ Bot-Key generiert ‚Äî gib ihn deinem Clawdbot',
    obBotKeyMissing: '‚ö†Ô∏è Bot noch nicht verbunden ‚Äî du kannst das sp√§ter in den Settings machen',
    connectBot: 'Bot verbinden ‚Üí',
    ttsLang: 'de-DE',
    botExplain: '<b>So verbindest du deinen Bot:</b><br>1. Klicke "Neuen Key generieren"<br>2. Kopiere den API-Key<br>3. Setze ihn in deinem Clawdbot als <b>ALARMBRIEFING_API_KEY</b><br>4. Der Bot kann dann Wecker erstellen, Briefings generieren und √ºber deine Lautsprecher abspielen.',
    namePlaceholderAlarm: 'z.B. Morgenwecker',
  },
  en: {
    days: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
    authDesc: 'Sign in to sync your alarms and briefings across devices.',
    register: 'Sign Up', login: 'Sign In',
    switchToLogin: 'Already have an account? <span>Sign In</span>',
    switchToRegister: 'No account yet? <span>Sign Up</span>',
    namePlaceholder: 'Name (optional)', emailPlaceholder: 'Email', passPlaceholder: 'Password (min. 8 characters)',
    alarmsActive: (n) => `${n} alarm${n!==1?'s':''} active`,
    briefingByBot: 'üéô Briefing created by bot',
    morningBriefing: 'Morning Briefing', briefingSources: 'Weather, events, news',
    noAlarms: 'No alarms yet.<br>Tap + or let your bot create one.',
    noBriefing: 'No briefing available yet. Your bot will create one.',
    newAlarm: 'New Alarm', done: 'Done', name: 'Name', weekdays: 'Weekdays', save: 'Save',
    briefingTitle: 'ü§ñ Briefing', briefingDesc: 'Your Clawdbot automatically decides what goes into the briefing ‚Äî weather, calendar, news, etc.',
    settings: 'Settings', back: '‚Üê Back',
    botConnection: 'Bot Connection', newKey: 'üîë Generate New Key', copy: 'üìã Copy',
    noBotConnected: 'No bot connected', keyGenerated: 'Key generated ‚Äî copy and give to your bot',
    briefingSourcesTitle: 'Briefing Sources', briefingSourcesDesc: 'Your bot collects this data and creates an audio briefing that plays when your alarm goes off ‚Äî like Jarvis.',
    weather: 'üå§ Weather', calendar: 'üìÖ Calendar', news: 'üì∞ News', tasks: '‚úÖ Tasks',
    audioTitle: 'Audio', audioDesc: 'Voice and speed for your audio briefing.',
    voice: 'Voice', speed: 'Speed',
    account: 'Account', email: 'Email', exportData: 'üì¶ Export data', logout: 'üö™ Sign out', deleteAccount: 'üóë Delete account',
    legal: 'Legal', privacy: 'Privacy Policy', terms: 'Terms of Service', imprint: 'Imprint', support: 'Support & Help',
    botActivity: 'Bot Activity', noActivity: 'No activity yet',
    snooze: 'üò¥ Snooze', dismiss: '‚úÖ Dismiss', briefingAfter: 'üéô Briefing will play after the alarm...',
    deleteConfirm: 'Really delete your account? All data will be permanently deleted:\n\n- Account & login\n- All alarms\n- All API keys\n- All briefings\n- Audit logs\n\nThis cannot be undone.',
    deleteConfirm2: 'Are you sure? Last chance.',
    oneTime: 'One-time',
    obWelcomeTitle: 'Welcome to<br><span>AlarmBriefing</span>',
    obWelcomeDesc: 'Your smart alarm clock with Jarvis-style briefings. Clawdbot creates alarms and reads you weather, events, and news every morning.',
    obHowTitle: 'How it works',
    obHow1: 'ü§ñ Your Clawdbot handles everything automatically', obHow2: '‚è∞ It creates alarms for you',
    obHow3: 'üéô It generates audio briefings (like Jarvis)', obHow4: 'üîä You hear your briefing when the alarm goes off',
    obConnectTitle: 'Connect Bot', obConnectDesc: 'Generate an API key and give it to your Clawdbot so it can access your app.',
    obGenBtn: 'üîë Generate Key', obGenerating: 'Generating...',
    obKeyGenerated: '‚úÖ Key generated!', obKeyCopyHint: 'Copy this key and set it as <b>ALARMBRIEFING_API_KEY</b> in your Clawdbot:',
    obTapCopy: 'Tap to copy', obConnectLater: 'Connect later',
    obReadyTitle: 'All set!', obReadyDesc: 'Your Clawdbot can now create alarms and generate briefings. Wake up like Tony Stark every morning.',
    obNext: 'Next ‚Üí', obBack: 'Back', obStart: 'Start App',
    obBotKeyDone: '‚úÖ Bot key generated ‚Äî give it to your Clawdbot',
    obBotKeyMissing: '‚ö†Ô∏è Bot not connected yet ‚Äî you can do this later in Settings',
    connectBot: 'Connect Bot ‚Üí',
    ttsLang: 'en-US',
    botExplain: '<b>How to connect your bot:</b><br>1. Click "Generate New Key"<br>2. Copy the API key<br>3. Set it as <b>ALARMBRIEFING_API_KEY</b> in your Clawdbot<br>4. The bot can then create alarms, generate briefings, and play them through your speakers.',
    namePlaceholderAlarm: 'e.g. Morning alarm',
  }
};
const L = I18N[LANG];
const DAYS = L.days;
let token = localStorage.getItem('ab_token');
let user = JSON.parse(localStorage.getItem('ab_user')||'null');
let onboarded = localStorage.getItem('ab_onboarded');
let alarms = [];
let currentBotKey = null;
let authMode = 'register';
let editDays = [1,2,3,4,5], editBrief = 'standard';

// === API ===
async function api(path, opts={}) {
  const headers = {'Content-Type':'application/json'};
  if (token) headers['Authorization'] = 'Bearer '+token;
  const r = await fetch(API+path, {...opts, headers:{...headers,...(opts.headers||{})}});
  const data = await r.json();
  if (!r.ok) throw new Error(data.error||'Fehler');
  return data;
}

// === AUTH ===
function toggleAuthMode() {
  authMode = authMode==='register'?'login':'register';
  document.getElementById('auth-btn').textContent = authMode==='register'?L.register:L.login;
  document.getElementById('auth-switch').innerHTML = authMode==='register'?L.switchToLogin:L.switchToRegister;
  document.getElementById('auth-name').style.display = authMode==='register'?'':'none';
  document.getElementById('auth-error').textContent = '';
}

function initI18nUI() {
  document.getElementById('auth-desc').textContent = L.authDesc;
  document.getElementById('auth-name').placeholder = L.namePlaceholder;
  document.getElementById('auth-email').placeholder = L.emailPlaceholder;
  document.getElementById('auth-pass').placeholder = L.passPlaceholder;
  document.getElementById('auth-btn').textContent = L.register;
  document.getElementById('auth-switch').innerHTML = L.switchToLogin;
  // Home
  document.getElementById('bp-title').textContent = L.morningBriefing;
  document.getElementById('bp-sub').textContent = L.briefingSources;
  // Modal
  document.getElementById('modal-title').textContent = L.newAlarm;
  document.getElementById('modal-done').textContent = L.done;
  document.getElementById('m-name-label').textContent = L.name;
  document.getElementById('m-name').placeholder = L.namePlaceholderAlarm;
  document.getElementById('m-days-label').textContent = L.weekdays;
  document.getElementById('m-briefing-title').textContent = L.briefingTitle;
  document.getElementById('m-briefing-desc').textContent = L.briefingDesc;
  document.getElementById('m-save-btn').textContent = L.save;
  // Alarm overlay
  document.getElementById('alarm-snooze-btn').textContent = L.snooze;
  document.getElementById('alarm-dismiss-btn').textContent = L.dismiss;
  document.getElementById('alarm-overlay-status').textContent = L.briefingAfter;
  // Settings header
  document.getElementById('settings-back').textContent = L.back;
  document.getElementById('settings-title').textContent = L.settings;
}

async function doAuth() {
  const email = document.getElementById('auth-email').value;
  const password = document.getElementById('auth-pass').value;
  const name = document.getElementById('auth-name').value;
  const errEl = document.getElementById('auth-error');
  errEl.textContent = '';
  try {
    const data = authMode==='register'
      ? await api('/api/auth/register',{method:'POST',body:JSON.stringify({email,password,name})})
      : await api('/api/auth/login',{method:'POST',body:JSON.stringify({email,password})});
    token = data.token;
    user = data.user;
    localStorage.setItem('ab_token', token);
    localStorage.setItem('ab_user', JSON.stringify(user));
    if (!onboarded) { showScreen('onboarding'); renderOb(); }
    else { showScreen('home'); loadAlarms(); }
  } catch(e) { errEl.textContent = e.message; }
}

function logout() {
  token = null; user = null;
  localStorage.removeItem('ab_token');
  localStorage.removeItem('ab_user');
  localStorage.removeItem('ab_onboarded');
  showScreen('auth');
}

// === ONBOARDING ===
let obStep = 0;
let obBotKey = null;
const obSteps = [
  { icon:'üîî', title:'Willkommen bei<br><span>AlarmBriefing</span>', desc:'Dein intelligenter Wecker mit Jarvis-Briefings. Der Clawdbot erstellt Wecker und spricht dir morgens Wetter, Termine und News ueber deine Lautsprecher vor.',
    extra:()=>`<div class="ob-box"><div class="ob-box-title">So funktioniert's</div><p>ü§ñ Dein Clawdbot steuert alles automatisch</p><p>‚è∞ Er erstellt Wecker fuer dich</p><p>üéô Er generiert Audio-Briefings (wie Jarvis)</p><p>üîä Beim Alarm hoerst du dein Briefing</p></div>`,
    btns:[{text:'Bot verbinden ‚Üí',blue:true,fn:'obNext()'}]},
  { icon:'üîë', title:'Bot verbinden', desc:'Generiere jetzt einen API-Key und gib ihn deinem Clawdbot. Damit kann er auf deine App zugreifen.',
    extra:()=>{
      if(obBotKey) return `
        <div class="ob-box"><div class="ob-box-title">‚úÖ Key generiert!</div><p>Kopiere diesen Key und gib ihn deinem Clawdbot als <b>ALARMBRIEFING_API_KEY</b>:</p></div>
        <div class="ob-key" onclick="navigator.clipboard.writeText('${obBotKey}');this.textContent='‚úì Kopiert!';setTimeout(()=>this.textContent='${obBotKey}',1500)">${obBotKey}</div>
        <div class="ob-key-hint">Antippen zum Kopieren</div>`;
      return `
        <div class="ob-box"><div class="ob-box-title">API-Key generieren</div><p>Klicke den Button um einen Key zu erstellen. Diesen Key braucht dein Clawdbot um auf die App zuzugreifen.</p></div>
        <button class="btn btn-blue btn-sm" onclick="obGenKey()" id="ob-gen-btn">üîë Key generieren</button>
        <div id="ob-gen-status" style="font-size:11px;color:var(--text-muted);margin-top:6px"></div>`;
    },
    btns:()=>obBotKey?[{text:'Zur√ºck',blue:false,fn:'obBack()'},{text:'Weiter ‚Üí',blue:true,fn:'obNext()'}]:[{text:'Zur√ºck',blue:false,fn:'obBack()'},{text:'Spaeter verbinden',blue:false,fn:'obNext()'}]},
  { icon:'‚úÖ', title:'Alles bereit!', desc:'Dein Clawdbot kann jetzt Wecker erstellen und Briefings generieren. Du wirst morgens wie Tony Stark geweckt.',
    extra:()=>`<div class="ob-box"><div class="ob-box-title">Naechste Schritte</div>
      <p>${obBotKey?'‚úÖ Bot-Key generiert ‚Äî gib ihn deinem Clawdbot':'‚ö†Ô∏è Bot noch nicht verbunden ‚Äî du kannst das spaeter in den Settings machen'}</p>
      <p>‚è∞ Erstelle deinen ersten Wecker</p>
      <p>üéô Dein Bot kuemmert sich um den Rest</p></div>`,
    btns:[{text:'Zur√ºck',blue:false,fn:'obBack()'},{text:'App starten',blue:true,fn:'finishOb()'}]}
];

function renderOb() {
  const s = obSteps[obStep];
  document.getElementById('ob-body').innerHTML = `<div class="ob-icon">${s.icon}</div><div class="ob-title">${s.title}</div><div class="ob-desc">${s.desc}</div>${typeof s.extra==='function'?s.extra():''}`;
  const btns = typeof s.btns==='function'?s.btns():s.btns;
  document.getElementById('ob-footer').innerHTML = btns.map(b=>`<button class="btn btn-flex ${b.blue?'btn-blue':''}" onclick="${b.fn}">${b.text}</button>`).join('');
  document.querySelectorAll('.ob-dot').forEach((d,i)=>d.className='ob-dot'+(i<=obStep?' active':''));
}
async function obGenKey(){
  const btn=document.getElementById('ob-gen-btn');
  const status=document.getElementById('ob-gen-status');
  btn.disabled=true;btn.textContent='Generiere...';
  try{
    const d=await api('/api/auth/bot-key',{method:'POST'});
    obBotKey=d.key;currentBotKey=d.key;
    renderOb();
  }catch(e){status.textContent='Fehler: '+e.message;btn.disabled=false;btn.textContent='üîë Key generieren'}
}
function obNext(){if(obStep<obSteps.length-1){obStep++;renderOb()}}
function obBack(){if(obStep>0){obStep--;renderOb()}}
function finishOb(){localStorage.setItem('ab_onboarded','1');onboarded='1';showScreen('home');loadAlarms()}

// === SCREENS ===
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('s-'+id).classList.add('active');
  if (id==='home') renderHome();
  if (id==='settings') renderSettings();
}

// === HOME ===
function normalizeAlarm(a){
  return {id:a.id, name:a.name, active:a.active, time:a.time, days:a.days||[],
    managedBy:a.managed_by||a.managedBy||'manual', briefingMode:a.briefing_mode||a.briefingMode||'auto',
    userId:a.user_id||a.userId};
}
async function loadAlarms() {
  try { const d = await api('/api/alarms'); alarms = (d.alarms||[]).map(normalizeAlarm); renderHome(); }
  catch(e) { console.error(e); renderHome(); }
}

function renderHome() {
  const sorted = [...alarms].sort((a,b)=>a.active===b.active?a.time.localeCompare(b.time):a.active?-1:1);
  const active = alarms.filter(a=>a.active);
  document.getElementById('home-sub').textContent = L.alarmsActive(active.length);

  const next = sorted.find(a=>a.active);
  if (next) {
    document.getElementById('na-time').textContent=next.time;
    document.getElementById('na-label').textContent=next.name;
    document.getElementById('na-brief').textContent=L.briefingByBot;
    document.getElementById('next-alarm').style.display='flex';
  } else { document.getElementById('next-alarm').style.display='none'; }

  const bp=document.getElementById('bp');
  if(active.some(a=>a.briefingMode!=='none'))bp.classList.add('active');else bp.classList.remove('active');

  const list=document.getElementById('alarm-list');
  if(sorted.length===0){
    list.innerHTML=`<div class="empty-state"><div class="icon">‚è∞</div><div>${L.noAlarms}</div></div>`;
    return;
  }
  list.innerHTML=sorted.map(a=>{
    const dh=a.days&&a.days.length?a.days.map(d=>`<span class="day-tag">${DAYS[d]}</span>`).join(''):`<span class="day-tag">${L.oneTime}</span>`;
    return`<div class="alarm-card ${a.active?'':'inactive'}"><div><div class="alarm-time">${a.time}</div><div class="alarm-meta">${a.name} ${a.managedBy==='bot'?'<span class="bot-tag">BOT</span>':''}</div><div class="alarm-days">${dh}</div></div><div class="toggle ${a.active?'on':''}" onclick="event.stopPropagation();toggleAlarm('${a.id}')"></div></div>`;
  }).join('');
}

async function toggleAlarm(id) {
  const a=alarms.find(x=>x.id===id);if(!a)return;
  a.active=!a.active;renderHome();
  // TODO: PATCH to API
}

function togglePlay(){
  if(tts.speaking){tts.stop();return;}
  if(latestBriefingText){tts.speak(latestBriefingText);}
  else{tts.speak(L.noBriefing);}
}

// === SETTINGS ===
function renderSettings() {
  const privacyUrl = LANG==='de'?'/privacy.html':'/privacy-en.html';
  const termsUrl = LANG==='de'?'/terms.html':'/terms-en.html';
  const imprintUrl = LANG==='de'?'/imprint.html':'/imprint-en.html';
  const supportUrl = LANG==='de'?'/support.html':'/support-en.html';

  document.getElementById('settings-body').innerHTML = `
    <div class="s-title">${L.botConnection}</div>
    <div class="s-card">
      <div class="s-explain">${L.botExplain}</div>
      <div class="s-row"><div style="display:flex;align-items:center;gap:6px"><div class="conn-dot ${currentBotKey?'on':'off'}" id="conn-dot"></div><span id="conn-label" style="font-size:12px">${currentBotKey?L.keyGenerated:L.noBotConnected}</span></div></div>
      ${currentBotKey?`<div class="api-key-box" id="api-key-box" onclick="copyKey()">${currentBotKey}</div>`:''}
      <div style="padding:8px 14px 10px;display:flex;gap:6px">
        <button class="btn btn-sm btn-blue btn-flex" onclick="genBotKey()">${L.newKey}</button>
        ${currentBotKey?`<button class="btn btn-sm btn-flex" id="copy-btn" onclick="copyKey()">${L.copy}</button>`:''}
      </div>
    </div>
    <div class="s-title">${L.briefingSourcesTitle||L.briefingSources}</div>
    <div class="s-card">
      <div class="s-explain">${L.briefingSourcesDesc}</div>
      <div class="s-row"><span>${L.weather}</span><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      <div class="s-row"><span>${L.calendar}</span><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      <div class="s-row"><span>${L.news}</span><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      <div class="s-row"><span>${L.tasks}</span><div class="toggle" onclick="this.classList.toggle('on')"></div></div>
    </div>
    <div class="s-title">${L.audioTitle}</div>
    <div class="s-card">
      <div class="s-explain">${L.audioDesc}</div>
      <div class="s-row"><span>${L.voice}</span><span class="s-dim">Jarvis</span></div>
      <div class="s-row"><span>${L.speed}</span><span class="s-dim">1.0x</span></div>
    </div>
    <div class="s-title">${L.account}</div>
    <div class="s-card">
      <div class="s-row"><span>${L.email}</span><span class="s-dim">${user?.email||'-'}</span></div>
      <div class="s-row" style="cursor:pointer" onclick="exportData()"><span>${L.exportData}</span><span class="s-dim">‚Üí</span></div>
      <div class="s-row" style="cursor:pointer" onclick="logout()"><span>${L.logout}</span><span class="s-dim">‚Üí</span></div>
      <div class="s-row danger" style="cursor:pointer" onclick="deleteAccount()"><span>${L.deleteAccount}</span><span class="s-dim">‚Üí</span></div>
    </div>
    <div class="s-title">${L.legal}</div>
    <div class="s-card">
      <a href="${privacyUrl}" style="text-decoration:none;color:var(--text)"><div class="s-row" style="cursor:pointer"><span>${L.privacy}</span><span class="s-dim">‚Üí</span></div></a>
      <a href="${termsUrl}" style="text-decoration:none;color:var(--text)"><div class="s-row" style="cursor:pointer"><span>${L.terms}</span><span class="s-dim">‚Üí</span></div></a>
      <a href="${imprintUrl}" style="text-decoration:none;color:var(--text)"><div class="s-row" style="cursor:pointer"><span>${L.imprint}</span><span class="s-dim">‚Üí</span></div></a>
      <a href="${supportUrl}" style="text-decoration:none;color:var(--text)"><div class="s-row" style="cursor:pointer"><span>${L.support}</span><span class="s-dim">‚Üí</span></div></a>
    </div>
    <div class="s-title">${L.botActivity}</div>
    <div class="s-card" id="audit-log"><div class="s-row"><span class="s-dim">${L.noActivity}</span></div></div>
    <div style="text-align:center;padding:16px 0;font-size:11px;color:var(--text-muted)">AlarmBriefing v1.0.0</div>
  `;
}

async function genBotKey() {
  try {
    const d = await api('/api/auth/bot-key',{method:'POST'});
    currentBotKey = d.key;
    document.getElementById('api-key-box').textContent=d.key;
    document.getElementById('api-key-box').style.display='';
    document.getElementById('copy-btn').style.display='';
    document.getElementById('conn-dot').className='conn-dot on';
    document.getElementById('conn-label').textContent='Key generiert ‚Äî kopieren und dem Bot geben';
  } catch(e) { alert(e.message); }
}

function copyKey() {
  if(!currentBotKey)return;
  navigator.clipboard.writeText(currentBotKey).then(()=>{
    const el=document.getElementById('api-key-box');
    const o=el.textContent;el.textContent='‚úì Kopiert!';setTimeout(()=>el.textContent=o,1500);
  });
}

// === MODAL ===
function openModal(){
  editDays=[1,2,3,4,5];
  document.getElementById('m-h').value='07';document.getElementById('m-m').value='00';document.getElementById('m-name').value='';
  renderDays();
  document.getElementById('modal').classList.add('active');
}
function closeModal(){document.getElementById('modal').classList.remove('active')}
function renderDays(){document.getElementById('m-days').innerHTML=DAYS.map((l,i)=>`<div class="day-btn ${editDays.includes(i)?'active':''}" onclick="editDays.includes(${i})?editDays=editDays.filter(x=>x!==${i}):editDays.push(${i});renderDays()">${l}</div>`).join('')}
async function saveAlarm(){
  const h=document.getElementById('m-h').value.padStart(2,'0');
  const m=document.getElementById('m-m').value.padStart(2,'0');
  const name=document.getElementById('m-name').value||'Alarm';
  try{
    await api('/api/alarms',{method:'POST',body:JSON.stringify({name,time:`${h}:${m}`,days:editDays,briefingMode:'auto'})});
    closeModal();loadAlarms();
  }catch(e){alert(e.message)}
}

// === TTS ENGINE ===
const tts = {
  speaking: false,
  utterance: null,
  
  getVoice() {
    const voices = speechSynthesis.getVoices();
    // Prefer German voices, then English
    return voices.find(v => v.lang.startsWith('de') && v.name.includes('Male')) ||
           voices.find(v => v.lang.startsWith('de')) ||
           voices.find(v => v.lang.startsWith('en') && v.name.includes('Male')) ||
           voices[0];
  },

  speak(text, onEnd) {
    if (!('speechSynthesis' in window)) { console.error('TTS not supported'); return; }
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.voice = this.getVoice();
    u.rate = 1.0;
    u.pitch = 0.9; // slightly deeper = more Jarvis
    u.volume = 1.0;
    u.lang = L.ttsLang;
    u.onstart = () => { this.speaking = true; updatePlayerUI(true); };
    u.onend = () => { this.speaking = false; updatePlayerUI(false); if (onEnd) onEnd(); };
    u.onerror = () => { this.speaking = false; updatePlayerUI(false); };
    this.utterance = u;
    speechSynthesis.speak(u);
  },

  stop() {
    speechSynthesis.cancel();
    this.speaking = false;
    updatePlayerUI(false);
  },

  // Play audio URL (for premium TTS like OpenAI)
  playAudio(url, onEnd) {
    const audio = new Audio(url);
    audio.onplay = () => { this.speaking = true; updatePlayerUI(true); };
    audio.onended = () => { this.speaking = false; updatePlayerUI(false); if (onEnd) onEnd(); };
    audio.onerror = () => { this.speaking = false; updatePlayerUI(false); };
    audio.play();
  }
};

function updatePlayerUI(playing) {
  const w = document.getElementById('bp-wave');
  const p = document.querySelector('.bp-play');
  if (playing) { w.style.display = 'flex'; p.textContent = '‚è∏'; }
  else { w.style.display = 'none'; p.textContent = '‚ñ∂'; }
}

// Load voices (async in some browsers)
if ('speechSynthesis' in window) {
  speechSynthesis.onvoiceschanged = () => tts.getVoice();
}

// === ALARM CHECKER ===
let lastAlarmCheck = '';
let latestBriefingText = 'Guten Morgen! Dein Briefing wird geladen...';

async function loadLatestBriefing() {
  try {
    const d = await api('/api/briefings/latest');
    if (d.briefing && d.briefing.content) {
      latestBriefingText = d.briefing.content;
      const bp = document.getElementById('bp');
      bp.classList.add('active');
      document.querySelector('.bp-sub').textContent = 
        d.briefing.modules ? d.briefing.modules.join(', ') : 'Briefing bereit';
    }
  } catch(e) { /* no briefing yet, ok */ }
}

function checkAlarms() {
  const now = new Date();
  const hhmm = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
  const day = now.getDay();
  
  if (hhmm === lastAlarmCheck) return; // only check once per minute
  lastAlarmCheck = hhmm;
  
  const triggered = alarms.find(a => a.active && a.time === hhmm && (a.days.length === 0 || a.days.includes(day)));
  if (triggered) {
    triggerAlarm(triggered);
  }
}

function triggerAlarm(alarm) {
  // Show alarm screen
  document.getElementById('alarm-overlay').classList.add('active');
  document.getElementById('alarm-overlay-name').textContent = alarm.name;
  document.getElementById('alarm-overlay-time').textContent = alarm.time;
  
  // Play alarm sound, then briefing
  playAlarmSound(() => {
    // After alarm sound, speak the briefing
    if (latestBriefingText) {
      tts.speak(latestBriefingText);
    }
  });
}

function playAlarmSound(onEnd) {
  // Simple alarm tone using Web Audio API
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.frequency.value = 880;
    osc.type = 'sine';
    gain.gain.value = 0.3;
    osc.start();
    
    // Beep pattern: on-off-on-off-on
    let beeps = 0;
    const interval = setInterval(() => {
      beeps++;
      gain.gain.value = gain.gain.value > 0 ? 0 : 0.3;
      if (beeps >= 8) {
        clearInterval(interval);
        osc.stop();
        ctx.close();
        if (onEnd) setTimeout(onEnd, 500);
      }
    }, 300);
  } catch(e) {
    if (onEnd) onEnd();
  }
}

function dismissAlarm() {
  document.getElementById('alarm-overlay').classList.remove('active');
  tts.stop();
}

function snoozeAlarm() {
  document.getElementById('alarm-overlay').classList.remove('active');
  tts.stop();
  // Snooze: re-trigger in 5 min
  setTimeout(() => {
    const now = new Date();
    const hhmm = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
    triggerAlarm({ name: 'Snooze', time: hhmm });
  }, 5 * 60 * 1000);
}

// Check alarms every 10 seconds
setInterval(checkAlarms, 10000);
// Load briefing periodically
setInterval(loadLatestBriefing, 60000);

// === ACCOUNT ===
async function deleteAccount(){
  if(!confirm(L.deleteConfirm)) return;
  if(!confirm(L.deleteConfirm2)) return;
  try{
    await api('/api/auth/delete',{method:'DELETE'});
    token=null;user=null;
    localStorage.clear();
    showScreen('auth');
  }catch(e){alert('Fehler: '+e.message+'\n\nAlternativ per Email an support@alarmbriefing.app')}
}

function exportData(){
  const data={user,alarms,exportedAt:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='alarmbriefing-export.json';a.click();
  URL.revokeObjectURL(url);
}

// === INIT ===
initI18nUI();
if(token && user){
  if(onboarded){showScreen('home');loadAlarms();loadLatestBriefing();}
  else{showScreen('onboarding');renderOb();}
}
</script>
</body>
</html>
