<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AlarmBriefing</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîî</text></svg>">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0e1a;
      --bg-card: #111827;
      --bg-card-hover: #1a2235;
      --bg-input: #0d1220;
      --border: #1e2a42;
      --blue: #3b82f6;
      --blue-light: #60a5fa;
      --blue-dark: #1d4ed8;
      --blue-glow: rgba(59,130,246,0.4);
      --blue-muted: rgba(59,130,246,0.12);
      --text: #e2e8f0;
      --text-dim: #64748b;
      --text-muted: #475569;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    html, body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100%;
      overflow: hidden;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background:
        radial-gradient(ellipse at 30% 20%, rgba(59,130,246,0.06) 0%, transparent 60%),
        radial-gradient(ellipse at 70% 80%, rgba(59,130,246,0.04) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    /* Phone Frame */
    .phone {
      width: 390px;
      height: 100%;
      max-height: 844px;
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    @media (min-width: 500px) {
      .phone {
        height: 90vh;
        border-radius: 40px;
        border: 2px solid var(--border);
        box-shadow: 0 20px 80px rgba(0,0,0,0.5), 0 0 60px rgba(59,130,246,0.05);
      }
    }

    @media (max-width: 500px) {
      .phone { width: 100%; max-height: 100%; }
    }

    /* Screens */
    .screen { display: none; flex-direction: column; flex: 1; overflow: hidden; }
    .screen.active { display: flex; }

    /* ===== ONBOARDING ===== */
    .ob {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 24px;
    }

    .ob-progress { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
    .ob-dot { width: 8px; height: 8px; border-radius: 4px; background: var(--border); transition: all 0.3s; }
    .ob-dot.active { background: var(--blue); width: 24px; box-shadow: 0 0 10px var(--blue-glow); }

    .ob-body { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .ob-icon { font-size: 56px; margin-bottom: 16px; }
    .ob-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; line-height: 1.3; }
    .ob-title span { color: var(--blue); }
    .ob-desc { font-size: 14px; color: var(--text-dim); line-height: 1.6; max-width: 300px; margin-bottom: 16px; }

    .ob-explain {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      text-align: left;
      width: 100%;
      max-width: 320px;
      margin-bottom: 12px;
    }
    .ob-explain-title { font-size: 12px; font-weight: 700; color: var(--blue); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .ob-explain p { font-size: 13px; color: var(--text-dim); line-height: 1.5; margin-bottom: 4px; }
    .ob-explain code { background: var(--blue-muted); color: var(--blue-light); padding: 1px 6px; border-radius: 4px; font-size: 12px; font-family: 'JetBrains Mono', monospace; }

    .ob-key-box {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--blue-light);
      word-break: break-all;
      width: 100%;
      max-width: 320px;
      text-align: center;
      margin-bottom: 8px;
      user-select: all;
      cursor: pointer;
    }

    .ob-footer { display: flex; gap: 10px; padding-top: 12px; }

    /* Buttons */
    .btn {
      padding: 13px 24px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text);
      border-radius: 14px;
      cursor: pointer;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn:hover { border-color: rgba(59,130,246,0.3); }
    .btn:active { transform: scale(0.97); }
    .btn-blue {
      background: linear-gradient(135deg, var(--blue), var(--blue-dark));
      border-color: var(--blue);
      color: white;
      box-shadow: 0 0 20px var(--blue-glow);
    }
    .btn-sm { padding: 8px 16px; font-size: 13px; border-radius: 10px; }
    .btn-full { width: 100%; }
    .btn-flex { flex: 1; }

    /* ===== HOME ===== */
    .home-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px 8px;
      flex-shrink: 0;
    }
    .home-title { font-size: 22px; font-weight: 800; }
    .home-title span { color: var(--blue); }
    .home-sub { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

    .icon-btn {
      width: 40px; height: 40px;
      border-radius: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }
    .icon-btn:hover { border-color: rgba(59,130,246,0.3); }

    /* Next Alarm Banner */
    .next-alarm {
      margin: 10px 20px;
      padding: 14px 16px;
      background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05));
      border: 1px solid rgba(59,130,246,0.2);
      border-radius: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    .next-alarm-icon { font-size: 28px; }
    .next-alarm-time { font-family: 'JetBrains Mono', monospace; font-size: 28px; font-weight: 700; color: var(--blue-light); }
    .next-alarm-label { font-size: 12px; color: var(--text-dim); }
    .next-alarm-briefing { font-size: 11px; color: var(--blue); margin-top: 2px; }

    /* Alarm List */
    .alarm-list { flex: 1; overflow-y: auto; padding: 8px 20px; }

    .alarm-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .alarm-card:hover { border-color: rgba(59,130,246,0.25); background: var(--bg-card-hover); }
    .alarm-card.inactive { opacity: 0.4; }

    .alarm-time { font-family: 'JetBrains Mono', monospace; font-size: 28px; font-weight: 700; line-height: 1; }
    .alarm-meta { font-size: 12px; color: var(--text-dim); margin-top: 3px; }
    .alarm-days { display: flex; gap: 3px; margin-top: 4px; }
    .day-tag { font-size: 9px; font-weight: 600; color: var(--blue-light); background: var(--blue-muted); padding: 2px 6px; border-radius: 5px; }
    .bot-tag { font-size: 9px; font-weight: 700; letter-spacing: 1px; color: var(--blue); background: var(--blue-muted); border: 1px solid rgba(59,130,246,0.2); padding: 2px 7px; border-radius: 5px; }

    .toggle { width: 44px; height: 24px; border-radius: 12px; background: var(--border); cursor: pointer; position: relative; transition: background 0.3s; flex-shrink: 0; }
    .toggle.on { background: var(--blue-muted); }
    .toggle::after { content: ''; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; border-radius: 50%; background: var(--text-dim); transition: all 0.3s; }
    .toggle.on::after { left: 23px; background: var(--blue); box-shadow: 0 0 8px var(--blue-glow); }

    /* FAB */
    .fab {
      position: absolute;
      bottom: 20px; right: 20px;
      width: 52px; height: 52px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--blue), var(--blue-dark));
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 24px var(--blue-glow);
      font-size: 26px; color: white;
      z-index: 10;
      transition: all 0.2s;
    }
    .fab:hover { transform: scale(1.1); }

    /* ===== SETTINGS ===== */
    .settings-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .back-link { color: var(--blue); cursor: pointer; font-size: 14px; font-weight: 500; }

    .settings-body { flex: 1; overflow-y: auto; padding: 0 20px 20px; }

    .s-title { font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.5px; margin: 18px 0 8px; }

    .s-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }

    .s-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    .s-row:last-child { border-bottom: none; }
    .s-row-dim { color: var(--text-dim); font-size: 13px; }

    .s-explain {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.5;
      background: rgba(59,130,246,0.03);
    }

    .api-key-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--blue-light);
      background: var(--bg-input);
      padding: 10px 14px;
      word-break: break-all;
      user-select: all;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }

    .conn-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .conn-dot.on { background: var(--success); box-shadow: 0 0 8px rgba(34,197,94,0.5); }
    .conn-dot.off { background: var(--danger); }

    /* ===== MODAL ===== */
    .modal-bg {
      display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
      z-index: 50; align-items: flex-end;
    }
    .modal-bg.active { display: flex; }

    .modal {
      width: 100%; max-height: 80%;
      background: var(--bg);
      border-top-left-radius: 20px; border-top-right-radius: 20px;
      border: 1px solid var(--border); border-bottom: none;
      overflow-y: auto;
      animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .modal-bar { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 10px auto; }
    .modal-head { display: flex; align-items: center; justify-content: space-between; padding: 6px 20px 14px; }
    .modal-title { font-size: 17px; font-weight: 700; }
    .modal-close { color: var(--blue); cursor: pointer; font-size: 14px; font-weight: 600; }
    .modal-body { padding: 0 20px 24px; }

    .time-input { display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 20px; }
    .time-field {
      font-family: 'JetBrains Mono', monospace; font-size: 48px; font-weight: 700;
      width: 90px; text-align: center;
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px;
      padding: 8px; color: var(--text); outline: none;
    }
    .time-field:focus { border-color: var(--blue); }
    .time-colon { font-family: 'JetBrains Mono', monospace; font-size: 40px; color: var(--blue); }

    .field { margin-bottom: 14px; }
    .field-label { font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }

    .input {
      width: 100%; padding: 11px 14px;
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px;
      color: var(--text); font-size: 14px; font-family: 'Inter', sans-serif; outline: none;
    }
    .input:focus { border-color: var(--blue); }

    .days-row { display: flex; gap: 5px; }
    .day-btn {
      flex: 1; text-align: center; padding: 9px 0; border-radius: 8px;
      background: var(--bg-card); border: 1px solid var(--border);
      color: var(--text-dim); font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; font-family: 'Inter', sans-serif;
    }
    .day-btn.active { background: var(--blue-muted); border-color: var(--blue); color: var(--blue); }

    .radio-group { display: flex; flex-direction: column; gap: 6px; }
    .radio-opt {
      display: flex; align-items: center; gap: 10px;
      padding: 11px 14px; background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 10px; cursor: pointer; transition: all 0.2s; font-size: 13px;
    }
    .radio-opt.active { border-color: var(--blue); background: var(--blue-muted); }
    .radio-dot-wrap { width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--text-dim); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .radio-opt.active .radio-dot-wrap { border-color: var(--blue); }
    .radio-dot-inner { width: 8px; height: 8px; border-radius: 50%; background: var(--blue); display: none; }
    .radio-opt.active .radio-dot-inner { display: block; }

    /* Briefing player */
    .briefing-player {
      margin: 10px 20px;
      padding: 12px 16px;
      background: var(--bg-card);
      border: 1px solid rgba(59,130,246,0.2);
      border-radius: 14px;
      display: none;
      flex-shrink: 0;
      align-items: center;
      gap: 12px;
    }
    .briefing-player.active { display: flex; }
    .bp-play {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--blue); display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 14px; color: white; flex-shrink: 0;
    }
    .bp-info { flex: 1; }
    .bp-title { font-size: 13px; font-weight: 600; }
    .bp-sub { font-size: 11px; color: var(--text-dim); }
    .bp-wave { display: flex; align-items: center; gap: 2px; height: 20px; }
    .bp-bar { width: 3px; border-radius: 2px; background: var(--blue); animation: wave 1s ease-in-out infinite; }
    .bp-bar:nth-child(1) { height: 8px; animation-delay: 0s; }
    .bp-bar:nth-child(2) { height: 16px; animation-delay: 0.15s; }
    .bp-bar:nth-child(3) { height: 10px; animation-delay: 0.3s; }
    .bp-bar:nth-child(4) { height: 20px; animation-delay: 0.45s; }
    .bp-bar:nth-child(5) { height: 12px; animation-delay: 0.6s; }
    @keyframes wave { 0%,100% { transform: scaleY(1); } 50% { transform: scaleY(0.4); } }
  </style>
</head>
<body>

<div class="phone" id="app">

  <!-- ===== ONBOARDING ===== -->
  <div class="screen active" id="s-onboarding">
    <div class="ob">
      <div class="ob-progress">
        <div class="ob-dot active" data-s="0"></div>
        <div class="ob-dot" data-s="1"></div>
        <div class="ob-dot" data-s="2"></div>
      </div>
      <div class="ob-body" id="ob-body"></div>
      <div class="ob-footer" id="ob-footer"></div>
    </div>
  </div>

  <!-- ===== HOME ===== -->
  <div class="screen" id="s-home">
    <div class="home-header">
      <div>
        <div class="home-title">Alarm<span>Briefing</span></div>
        <div class="home-sub" id="home-sub">3 Alarme aktiv</div>
      </div>
      <div class="icon-btn" onclick="showScreen('settings')">‚öô</div>
    </div>

    <div class="next-alarm" id="next-alarm">
      <div class="next-alarm-icon">‚è∞</div>
      <div>
        <div class="next-alarm-time" id="na-time">06:30</div>
        <div class="next-alarm-label" id="na-label">Morgenwecker ¬∑ in 7h 23min</div>
        <div class="next-alarm-briefing" id="na-briefing">‚òÄ Briefing: Wetter, News, Kalender</div>
      </div>
    </div>

    <div class="briefing-player" id="briefing-player">
      <div class="bp-play" onclick="toggleBriefingPlay()">‚ñ∂</div>
      <div class="bp-info">
        <div class="bp-title">Morgenbriefing</div>
        <div class="bp-sub">Wetter 14¬∞C, 2 Termine, 3 News</div>
      </div>
      <div class="bp-wave" id="bp-wave" style="display:none">
        <div class="bp-bar"></div><div class="bp-bar"></div><div class="bp-bar"></div><div class="bp-bar"></div><div class="bp-bar"></div>
      </div>
    </div>

    <div class="alarm-list" id="alarm-list"></div>
    <div class="fab" onclick="openModal()">+</div>
  </div>

  <!-- ===== SETTINGS ===== -->
  <div class="screen" id="s-settings">
    <div class="settings-header">
      <span class="back-link" onclick="showScreen('home')">‚Üê Zur√ºck</span>
      <span style="font-weight:600;font-size:16px">Einstellungen</span>
      <span style="width:50px"></span>
    </div>
    <div class="settings-body">

      <div class="s-title">Bot-Verbindung</div>
      <div class="s-card">
        <div class="s-explain">
          Damit dein Clawdbot Alarme erstellen und Briefings generieren kann, braucht er diesen API-Key.
          Kopiere den Key und fuege ihn in deinem Bot als <b>ALARMBRIEFING_API_KEY</b> ein.
          Der Bot kann dann Wecker setzen, aendern und loeschen ‚Äî und TTS-Briefings fuer dich generieren.
        </div>
        <div class="s-row">
          <div style="display:flex;align-items:center;gap:8px">
            <div class="conn-dot on" id="conn-dot"></div>
            <span id="conn-label">Bot verbunden</span>
          </div>
        </div>
        <div class="api-key-display" id="api-key-display" onclick="copyApiKey()"></div>
        <div style="padding:8px 14px 12px;display:flex;gap:8px">
          <button class="btn btn-sm btn-flex" onclick="copyApiKey()">üìã Key kopieren</button>
          <button class="btn btn-sm btn-flex btn-blue" onclick="regenerateKey()">üîÑ Neu generieren</button>
        </div>
      </div>

      <div class="s-title">Briefing-Quellen</div>
      <div class="s-card">
        <div class="s-explain">Waehle welche Infos dein Morgenbriefing enthalten soll. Der Bot sammelt diese Daten und erstellt ein Audio-Briefing (wie Jarvis).</div>
        <div class="s-row"><span>üå§ Wetter</span><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span>üìÖ Kalender</span><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span>üì∞ Nachrichten</span><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span>‚úÖ Aufgaben</span><div class="toggle" onclick="this.classList.toggle('on')"></div></div>
      </div>

      <div class="s-title">Audio</div>
      <div class="s-card">
        <div class="s-explain">Stimme und Tempo fuer dein Audio-Briefing. Wird ueber die Lautsprecher abgespielt wenn der Alarm klingelt.</div>
        <div class="s-row"><span>Stimme</span><span class="s-row-dim">Jarvis (Standard)</span></div>
        <div class="s-row"><span>Sprechtempo</span><span class="s-row-dim">1.0x</span></div>
        <div class="s-row"><span>Lautst√§rke</span><span class="s-row-dim">System</span></div>
      </div>

      <div class="s-title">Standort</div>
      <div class="s-card">
        <div class="s-explain">F√ºr lokales Wetter im Briefing. Wird nur f√ºr Wetterdaten verwendet.</div>
        <div class="s-row"><span>üìç Standort</span><span class="s-row-dim" id="location-val">Berlin, DE</span></div>
      </div>

      <div class="s-title">Bot-Aktivit√§ten</div>
      <div class="s-card" id="audit-log"></div>
    </div>
  </div>

  <!-- ===== ALARM MODAL ===== -->
  <div class="modal-bg" id="modal" onclick="if(event.target===this)closeModal()">
    <div class="modal">
      <div class="modal-bar"></div>
      <div class="modal-head">
        <span class="modal-title">Neuer Wecker</span>
        <span class="modal-close" onclick="closeModal()">Fertig</span>
      </div>
      <div class="modal-body">
        <div class="time-input">
          <input class="time-field" id="m-hours" value="07" maxlength="2">
          <span class="time-colon">:</span>
          <input class="time-field" id="m-minutes" value="00" maxlength="2">
        </div>
        <div class="field">
          <div class="field-label">Name</div>
          <input class="input" id="m-name" placeholder="z.B. Morgenwecker">
        </div>
        <div class="field">
          <div class="field-label">Wochentage</div>
          <div class="days-row" id="m-days"></div>
        </div>
        <div class="field">
          <div class="field-label">Briefing</div>
          <div class="radio-group" id="m-briefing"></div>
        </div>
        <button class="btn btn-blue btn-full" onclick="saveAlarm()" style="margin-top:8px">Speichern</button>
      </div>
    </div>
  </div>
</div>

<script>
const DAYS = ['So','Mo','Di','Mi','Do','Fr','Sa'];
const STORAGE_KEY = 'ab_onboarded';
const API_KEY_STORE = 'ab_api_key';
const ALARMS_STORE = 'ab_alarms';

// ===== API KEY =====
function getApiKey() {
  let k = localStorage.getItem(API_KEY_STORE);
  if (!k) { k = generateKey(); localStorage.setItem(API_KEY_STORE, k); }
  return k;
}
function generateKey() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let r = 'ab_';
  for (let i = 0; i < 32; i++) r += chars[Math.floor(Math.random() * chars.length)];
  return r;
}
function regenerateKey() {
  const k = generateKey();
  localStorage.setItem(API_KEY_STORE, k);
  document.getElementById('api-key-display').textContent = k;
}
function copyApiKey() {
  navigator.clipboard.writeText(getApiKey()).then(() => {
    const el = document.getElementById('api-key-display');
    const orig = el.textContent;
    el.textContent = '‚úì Kopiert!';
    setTimeout(() => el.textContent = orig, 1500);
  });
}

// ===== ALARMS =====
let alarms = JSON.parse(localStorage.getItem(ALARMS_STORE)) || [
  { id:'1', name:'Morgenwecker', on:true, time:'06:30', days:[1,2,3,4,5], briefing:'standard', bot:true },
  { id:'2', name:'Workout', on:true, time:'07:15', days:[1,3,5], briefing:'short', bot:true },
  { id:'3', name:'Meeting Prep', on:true, time:'08:45', days:[1,2,3,4,5], briefing:'standard', bot:false },
  { id:'4', name:'Wochenende', on:false, time:'09:00', days:[0,6], briefing:'none', bot:false },
];
function saveAlarms() { localStorage.setItem(ALARMS_STORE, JSON.stringify(alarms)); }

const auditLog = [
  { who:'BOT', text:'Wecker "Morgenwecker" erstellt', when:'Heute, 05:30' },
  { who:'BOT', text:'Briefing generiert: Wetter 14¬∞C, 2 Termine', when:'Heute, 06:25' },
  { who:'BOT', text:'Wecker "Workout" Zeit ‚Üí 07:15', when:'Heute, 05:31' },
  { who:'USER', text:'Wecker "Meeting Prep" erstellt', when:'Gestern, 21:15' },
];

// ===== ONBOARDING =====
let obStep = 0;
const obSteps = [
  {
    icon: 'üîî',
    title: 'Willkommen bei<br><span>AlarmBriefing</span>',
    desc: 'Dein intelligenter Wecker mit Audio-Briefings ‚Äî wie Jarvis. Wach auf und hoere sofort Wetter, Termine und News ueber deine Lautsprecher.',
    extra: '',
    btns: [{ text:'Los geht\'s', blue:true, fn:'obNext()' }]
  },
  {
    icon: 'ü§ñ',
    title: 'Bot-Verbindung',
    desc: 'Dein Clawdbot steuert die App. Er erstellt Wecker, generiert Briefings und spielt sie ab wenn der Alarm klingelt.',
    extra: () => `
      <div class="ob-explain">
        <div class="ob-explain-title">So funktioniert's</div>
        <p>1. Die App generiert einen <b>API-Key</b> fuer dich</p>
        <p>2. Gib diesen Key deinem Clawdbot</p>
        <p>3. Der Bot kann dann Alarme setzen und Briefings erstellen</p>
        <p>4. Beim Alarm hoerst du das Briefing ueber deine Lautsprecher</p>
      </div>
      <div class="ob-explain" style="margin-top:8px">
        <div class="ob-explain-title">Dein API-Key</div>
        <p>Kopiere diesen Key und fuege ihn als <code>ALARMBRIEFING_API_KEY</code> in deinem Bot ein:</p>
      </div>
      <div class="ob-key-box" onclick="navigator.clipboard.writeText(this.textContent)">${getApiKey()}</div>
      <div style="font-size:12px;color:var(--text-muted)">Antippen zum Kopieren</div>
    `,
    btns: [{ text:'Zur√ºck', blue:false, fn:'obBack()' }, { text:'Weiter', blue:true, fn:'obNext()' }]
  },
  {
    icon: '‚úÖ',
    title: 'Alles bereit!',
    desc: 'Dein Bot kann jetzt Wecker erstellen und Briefings generieren. Morgens wirst du wie Tony Stark geweckt.',
    extra: () => `
      <div class="ob-explain">
        <div class="ob-explain-title">Was dein Bot kann</div>
        <p>‚è∞ Wecker erstellen, aendern, loeschen</p>
        <p>üéô Audio-Briefings generieren (TTS)</p>
        <p>üå§ Wetter, Kalender, News einbinden</p>
        <p>üîä Briefing ueber Lautsprecher abspielen</p>
      </div>
    `,
    btns: [{ text:'Zur√ºck', blue:false, fn:'obBack()' }, { text:'App starten', blue:true, fn:'finishOnboarding()' }]
  }
];

function renderOb() {
  const s = obSteps[obStep];
  const extra = typeof s.extra === 'function' ? s.extra() : s.extra;
  document.getElementById('ob-body').innerHTML = `
    <div class="ob-icon">${s.icon}</div>
    <div class="ob-title">${s.title}</div>
    <div class="ob-desc">${s.desc}</div>
    ${extra}
  `;
  document.getElementById('ob-footer').innerHTML = s.btns.map(b =>
    `<button class="btn btn-flex ${b.blue?'btn-blue':''}" onclick="${b.fn}">${b.text}</button>`
  ).join('');
  document.querySelectorAll('.ob-dot').forEach((d,i) => d.className = 'ob-dot' + (i <= obStep ? ' active' : ''));
}

function obNext() { if (obStep < obSteps.length-1) { obStep++; renderOb(); } }
function obBack() { if (obStep > 0) { obStep--; renderOb(); } }
function finishOnboarding() { localStorage.setItem(STORAGE_KEY, '1'); showScreen('home'); }

// ===== SCREENS =====
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('s-'+id).classList.add('active');
  if (id === 'home') renderHome();
  if (id === 'settings') renderSettings();
}

// ===== HOME =====
function renderHome() {
  const sorted = [...alarms].sort((a,b) => a.on === b.on ? a.time.localeCompare(b.time) : a.on ? -1 : 1);
  const active = alarms.filter(a => a.on);
  document.getElementById('home-sub').textContent = `${active.length} Alarm${active.length!==1?'e':''} aktiv`;

  const next = sorted.find(a => a.on);
  if (next) {
    document.getElementById('na-time').textContent = next.time;
    document.getElementById('na-label').textContent = next.name;
    const bl = next.briefing === 'none' ? 'Nur Alarm' : next.briefing === 'short' ? 'Kurzbriefing' : 'Wetter, News, Kalender';
    document.getElementById('na-briefing').textContent = next.briefing !== 'none' ? 'üéô Briefing: ' + bl : 'üîï Kein Briefing';
    document.getElementById('next-alarm').style.display = 'flex';
  } else {
    document.getElementById('next-alarm').style.display = 'none';
  }

  // Show briefing player for demo
  const bp = document.getElementById('briefing-player');
  if (active.some(a => a.briefing !== 'none')) bp.classList.add('active');
  else bp.classList.remove('active');

  document.getElementById('alarm-list').innerHTML = sorted.map(a => {
    const daysHtml = a.days.length ? a.days.map(d => `<span class="day-tag">${DAYS[d]}</span>`).join('') : '<span class="day-tag">Einmalig</span>';
    const briefLbl = a.briefing === 'none' ? 'Nur Alarm' : a.briefing === 'short' ? 'Kurzbriefing' : 'Standardbriefing';
    return `<div class="alarm-card ${a.on?'':'inactive'}" onclick="openDetail('${a.id}')">
      <div>
        <div class="alarm-time">${a.time}</div>
        <div class="alarm-meta">${a.name} ¬∑ ${briefLbl} ${a.bot?'<span class="bot-tag">BOT</span>':''}</div>
        <div class="alarm-days">${daysHtml}</div>
      </div>
      <div class="toggle ${a.on?'on':''}" onclick="event.stopPropagation();toggleAlarm('${a.id}')"></div>
    </div>`;
  }).join('');
}

function toggleAlarm(id) {
  const a = alarms.find(x=>x.id===id);
  if (a) { a.on = !a.on; saveAlarms(); renderHome(); }
}

function toggleBriefingPlay() {
  const w = document.getElementById('bp-wave');
  const p = document.querySelector('.bp-play');
  if (w.style.display === 'none') { w.style.display = 'flex'; p.textContent = '‚è∏'; }
  else { w.style.display = 'none'; p.textContent = '‚ñ∂'; }
}

// ===== SETTINGS =====
function renderSettings() {
  document.getElementById('api-key-display').textContent = getApiKey();
  document.getElementById('audit-log').innerHTML = auditLog.map(e => `
    <div class="s-row" style="flex-direction:column;align-items:flex-start;gap:2px">
      <div style="display:flex;align-items:center;gap:6px">
        <span style="font-size:9px;font-weight:700;letter-spacing:1px;padding:1px 6px;border-radius:4px;background:${e.who==='BOT'?'var(--blue-muted)':'rgba(34,197,94,0.12)'};color:${e.who==='BOT'?'var(--blue)':'var(--success)'}">${e.who}</span>
        <span style="font-size:13px">${e.text}</span>
      </div>
      <span style="font-size:11px;color:var(--text-muted)">${e.when}</span>
    </div>
  `).join('');
}

// ===== MODAL =====
let editDays = [1,2,3,4,5], editBriefing = 'standard';

function openModal() {
  editDays = [1,2,3,4,5]; editBriefing = 'standard';
  document.getElementById('m-hours').value = '07';
  document.getElementById('m-minutes').value = '00';
  document.getElementById('m-name').value = '';
  renderModalDays(); renderModalBriefing();
  document.getElementById('modal').classList.add('active');
}
function openDetail(id) {
  const a = alarms.find(x=>x.id===id);
  if (!a) return;
  editDays = [...a.days]; editBriefing = a.briefing;
  document.getElementById('m-hours').value = a.time.split(':')[0];
  document.getElementById('m-minutes').value = a.time.split(':')[1];
  document.getElementById('m-name').value = a.name;
  renderModalDays(); renderModalBriefing();
  document.getElementById('modal').classList.add('active');
}
function closeModal() { document.getElementById('modal').classList.remove('active'); }

function renderModalDays() {
  document.getElementById('m-days').innerHTML = DAYS.map((l,i) =>
    `<div class="day-btn ${editDays.includes(i)?'active':''}" onclick="editDays.includes(${i})?editDays=editDays.filter(x=>x!==${i}):editDays.push(${i});renderModalDays()">${l}</div>`
  ).join('');
}
function renderModalBriefing() {
  const opts = [['none','Nur Alarm ‚Äî kein Briefing'],['short','Kurzbriefing (10-30 Sek.)'],['standard','Vollbriefing (1-3 Min.)']];
  document.getElementById('m-briefing').innerHTML = opts.map(([k,l]) =>
    `<div class="radio-opt ${editBriefing===k?'active':''}" onclick="editBriefing='${k}';renderModalBriefing()">
      <div class="radio-dot-wrap"><div class="radio-dot-inner"></div></div><span>${l}</span>
    </div>`
  ).join('');
}
function saveAlarm() {
  const h = document.getElementById('m-hours').value.padStart(2,'0');
  const m = document.getElementById('m-minutes').value.padStart(2,'0');
  alarms.push({ id: Date.now()+'', name: document.getElementById('m-name').value||'Alarm', on:true, time:`${h}:${m}`, days:[...editDays], briefing:editBriefing, bot:false });
  saveAlarms(); closeModal(); renderHome();
}

// ===== INIT =====
if (localStorage.getItem(STORAGE_KEY)) {
  showScreen('home');
} else {
  renderOb();
}
</script>
</body>
</html>
